---
title: "Data management"
author: "Lennart OelschlÃ¤ger, Timo Adam and Rouven Michels"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Data management}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!-- 
Assignee: Lennart
Purpose: handling of empirical and simulated financial data in fHMM
--> 

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.dim = c(8,6),
  out.width = "80%",
  fig.align = 'center'
)
```

This vignette explains how to prepare or simulate data in fHMM for estimation. The vignette was build using R `r paste(R.Version()[6:7], collapse = ".")` with the fHMM `r utils::packageVersion("fHMM")` package.

```{r load fHMM}
library(fHMM)
```

## Empirical data

Empirical data for modeling must be in csv-format and its path must be specified in `set_controls()`, see [the vignette on specifying the controls](http://loelschlaeger.de/fHMM/articles/v02_controls.html) for details^[The `download_data()` function explaind below provides a convenient tool for downloading stock data from https://finance.yahoo.com/ in a suitable format.] We assume here that our working directory contains such a file named `dax.csv`:

```{r, download dax data, include = FALSE}
download_data(symbol = "^GDAXI", file = "dax.csv")
```
```{r, head dax}
str(read.csv("dax.csv"))
``` 

The `prepare_data()` function prepares the data based on the `data` controls specifications and returns an `fHMM_data` object that can be passed to the `fit_model()` function.

```{r, prepare_data example}
controls = list(
  states = 3,
  sdds   = "t",
  data   = list(file        = "dax.csv",
                date_column = "Date",
                data_column = "Close",
                logreturns  = TRUE)
)
controls <- set_controls(controls)
data <- prepare_data(controls)
class(data)
summary(data)
```

## Download stock data

You can download daily stock prices listed on https://finance.yahoo.com/ via

```{r, eval = FALSE} 
download_data(symbol, from, to, file)
```

where

- `symbol` is the stock's symbol that has to match the official symbol on <https://finance.yahoo.com>,

- `from` and `to` define the time interval (in format `"YYYY-MM-DD"`),

- `file` is the name of the file where the .csv-file is saved. Per default, it is saved in the current working directory under the name `<symbol>.csv`.

For example, the call

```{r}
download_data(symbol = "^GDAXI", from = "2000-01-01", to = Sys.Date())
```

downloads the 21st century daily data of the Deutscher Aktienindex into the current working directory.

## Highlighting events

Historical events can be highlighted in empirical data time series by specifying a named list `events` with elements `dates` (a vector of dates) and `names` (a vector of names for the events) and passing it to the plot method, for example:

```{r, events, eval = FALSE}
events = fHMM_events(
  list(
    dates = c("2001-09-11","2008-09-15","2020-01-27"),
    labels = c("9/11 terrorist attack","Bankruptcy of Lehman Brothers","First COVID-19 case in Germany")
    )
  )
print(events)
plot(data, events = events)
```

## Simulated data

If the `data` parameter in the model's `controls` is unspecified, the model is fitted to simulated data from the model specification. This is handy for testing the functionality or conducting simulation experiments. Model parameters can be specified by defining an `fHMM_parameters`-object via the `fHMM_parameters()` function. 
