<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Model estimation • fHMM</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Model estimation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fHMM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.4.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/fHMM.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/v01_model_definition.html">Model definition</a></li>
    <li><a class="dropdown-item" href="../articles/v02_controls.html">Controls</a></li>
    <li><a class="dropdown-item" href="../articles/v03_data_management.html">Data management</a></li>
    <li><a class="dropdown-item" href="../articles/v04_model_estimation.html">Model estimation</a></li>
    <li><a class="dropdown-item" href="../articles/v05_state_decoding_and_prediction.html">State decoding and prediction</a></li>
    <li><a class="dropdown-item" href="../articles/v06_model_checking.html">Model checking</a></li>
    <li><a class="dropdown-item" href="../articles/v07_model_selection.html">Model selection</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/loelschlaeger/fHMM/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Model estimation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/loelschlaeger/fHMM/blob/master/vignettes/v04_model_estimation.Rmd" class="external-link"><code>vignettes/v04_model_estimation.Rmd</code></a></small>
      <div class="d-none name"><code>v04_model_estimation.Rmd</code></div>
    </div>

    
    
<p>The <a href="https://loelschlaeger.de/fHMM/">fHMM</a> package fits a hidden Markov model via the
maximum-likelihood method, i.e. by numerically maximizing the likelihood
function. This vignette<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;This vignette was build using R 4.4.1 with the
&lt;a href="https://loelschlaeger.de/fHMM/"&gt;fHMM&lt;/a&gt; 1.4.0 package.&lt;/p&gt;'><sup>1</sup></a> derives the likelihood formula, discusses
challenges associated with the likelihood maximization and presents the
model estimation workflow.</p>
<div class="section level2">
<h2 id="likelihood-evaluation-using-the-forward-algorithm">Likelihood evaluation using the forward algorithm<a class="anchor" aria-label="anchor" href="#likelihood-evaluation-using-the-forward-algorithm"></a>
</h2>
<p>Deriving the likelihood function of an hidden Markov model is part of
the hierarchical case, hence the following only discusses the general
case.</p>
<p>An HHMM can be treated as an HMM with two conditionally independent
data streams; the coarse-scale observations on the one hand and the
corresponding chunk of fine-scale observations connected to a fine-scale
HMM on the other hand. To derive the likelihood of an HHMM, we start by
computing the likelihood of each chunk of fine-scale observations being
generated by each fine-scale HMM.</p>
<p>To fit the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>-th
fine-scale HMM, with model parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>θ</mi><mrow><mo>*</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>δ</mi><mrow><mo>*</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup><mo>,</mo><msup><mi>Γ</mi><mrow><mo>*</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup><mo>,</mo><msub><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>f</mi><mrow><mo>*</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo>,</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\theta^{*(i)}=(\delta^{*(i)}, \Gamma^{*(i)},(f^{*(i,k)})_k)</annotation></semantics></math>
to the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>-th
chunk of fine-scale observations, which is denoted by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mrow><mi>t</mi><mo>,</mo><msup><mi>t</mi><mo>*</mo></msup></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><msup><mi>t</mi><mo>*</mo></msup></msub><annotation encoding="application/x-tex">(X_{t,t^*})_{t^*}</annotation></semantics></math>,
we consider the fine-scale forward probabilities
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msubsup><mi>α</mi><mrow><mi>k</mi><mo>,</mo><msup><mi>t</mi><mo>*</mo></msup></mrow><mrow><mo>*</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msubsup><mo>=</mo><msup><mi>f</mi><mrow><mo>*</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>X</mi><mrow><mi>t</mi><mo>,</mo><mn>1</mn></mrow><mo>*</mo></msubsup><mo>,</mo><mi>…</mi><mo>,</mo><msubsup><mi>X</mi><mrow><mi>t</mi><mo>,</mo><msup><mi>t</mi><mo>*</mo></msup></mrow><mo>*</mo></msubsup><mo>,</mo><msubsup><mi>S</mi><mrow><mi>t</mi><mo>,</mo><msup><mi>t</mi><mo>*</mo></msup></mrow><mo>*</mo></msubsup><mo>=</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
\alpha^{*(i)}_{k,t^*}=f^{*(i)}(X^*_{t,1},\dots,X^*_{t,t^*}, S^*_{t,t^*}=k),
\end{align*}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>t</mi><mo>*</mo></msup><mo>=</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><msup><mi>T</mi><mo>*</mo></msup></mrow><annotation encoding="application/x-tex">t^*=1,\dots,T^*</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><msup><mi>N</mi><mo>*</mo></msup></mrow><annotation encoding="application/x-tex">k=1,\dots,N^*</annotation></semantics></math>.
Using the fine-scale forward probabilities, the fine-scale likelihoods
can be obtained from the law of total probability as
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msup><mi>ℒ</mi><mtext mathvariant="normal">HMM</mtext></msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>θ</mi><mrow><mo>*</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup><mo>∣</mo><msub><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>X</mi><mrow><mi>t</mi><mo>,</mo><msup><mi>t</mi><mo>*</mo></msup></mrow><mo>*</mo></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><msup><mi>t</mi><mo>*</mo></msup></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><munderover><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><msup><mi>N</mi><mo>*</mo></msup></munderover><msubsup><mi>α</mi><mrow><mi>k</mi><mo>,</mo><msup><mi>T</mi><mo>*</mo></msup></mrow><mrow><mo>*</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msubsup><mi>.</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
\mathcal{L}^\text{HMM}(\theta^{*(i)}\mid (X^*_{t,t^*})_{t^*})=\sum_{k=1}^{N^*}\alpha^{*(i)}_{k,T^*}.
\end{align*}</annotation></semantics></math> The forward probabilities
can be calculated in a recursively as
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msubsup><mi>α</mi><mrow><mi>k</mi><mo>,</mo><mn>1</mn></mrow><mrow><mo>*</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msubsup></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msubsup><mi>δ</mi><mi>k</mi><mrow><mo>*</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msubsup><msup><mi>f</mi><mrow><mo>*</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo>,</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>X</mi><mrow><mi>t</mi><mo>,</mo><mn>1</mn></mrow><mo>*</mo></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msubsup><mi>α</mi><mrow><mi>k</mi><mo>,</mo><msup><mi>t</mi><mo>*</mo></msup></mrow><mrow><mo>*</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msubsup></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mi>f</mi><mrow><mo>*</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo>,</mo><mi>k</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>X</mi><mrow><mi>t</mi><mo>,</mo><msup><mi>t</mi><mo>*</mo></msup></mrow><mo>*</mo></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><msup><mi>N</mi><mo>*</mo></msup></munderover><msubsup><mi>γ</mi><mrow><mi>j</mi><mi>k</mi></mrow><mrow><mo>*</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msubsup><msubsup><mi>α</mi><mrow><mi>j</mi><mo>,</mo><msup><mi>t</mi><mo>*</mo></msup><mo>−</mo><mn>1</mn></mrow><mrow><mo>*</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msubsup><mo>,</mo><mspace width="1.0em"></mspace><msup><mi>t</mi><mo>*</mo></msup><mo>=</mo><mn>2</mn><mo>,</mo><mi>…</mi><mo>,</mo><msup><mi>T</mi><mo>*</mo></msup><mi>.</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
\alpha^{*(i)}_{k,1} &amp;= \delta^{*(i)}_k f^{*(i,k)}(X^*_{t,1}), \\
\alpha^{*(i)}_{k,t^*} &amp;= f^{*(i,k)}(X^*_{t,t^*})\sum_{j=1}^{N^*}\gamma^{*(i)}_{jk}\alpha^{*(i)}_{j,t^*-1}, \quad t^*=2,\dots,T^*.
\end{align*}</annotation></semantics></math></p>
<p>The transition from the likelihood function of an HMM to the
likelihood function of an HHMM is straightforward: Consider the
coarse-scale forward probabilities
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>α</mi><mrow><mi>i</mi><mo>,</mo><mi>t</mi></mrow></msub><mo>=</mo><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mn>1</mn></msub><mo>,</mo><mi>…</mi><mo>,</mo><msub><mi>X</mi><mi>t</mi></msub><mo>,</mo><msub><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>X</mi><mrow><mn>1</mn><mo>,</mo><msup><mi>t</mi><mo>*</mo></msup></mrow><mo>*</mo></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><msup><mi>t</mi><mo>*</mo></msup></msub><mo>,</mo><mi>…</mi><mo>,</mo><msub><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>X</mi><mrow><mi>t</mi><mo>,</mo><msup><mi>t</mi><mo>*</mo></msup></mrow><mo>*</mo></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><msup><mi>t</mi><mo>*</mo></msup></msub><mo>,</mo><msub><mi>S</mi><mi>t</mi></msub><mo>=</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
\alpha_{i,t}=f(X_1,\dots,X_t,(X^*_{1,t^*})_{t^*},\dots,(X^*_{t,t^*})_{t^*}, S_t=i),
\end{align*}</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>T</mi></mrow><annotation encoding="application/x-tex">t=1,\dots,T</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">i=1,\dots,N</annotation></semantics></math>.
The likelihood function of the HHMM results as
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msup><mi>ℒ</mi><mtext mathvariant="normal">HHMM</mtext></msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>θ</mi><mo>,</mo><msub><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>θ</mi><mrow><mo>*</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mi>i</mi></msub><mo>∣</mo><msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>t</mi></msub><mo>,</mo><msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>X</mi><mrow><mi>t</mi><mo>,</mo><msup><mi>t</mi><mo>*</mo></msup></mrow><mo>*</mo></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><msup><mi>t</mi><mo>*</mo></msup></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msub><mi>α</mi><mrow><mi>i</mi><mo>,</mo><mi>T</mi></mrow></msub><mi>.</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
\mathcal{L}^\text{HHMM}(\theta,(\theta^{*(i)})_i\mid (X_t)_t,((X^*_{t,t^*})_{t^*})_t)=\sum_{i=1}^{N}\alpha_{i,T}.
\end{align*}</annotation></semantics></math> The coarse-scale forward
probabilities can be calculated similarly by applying the recursive
scheme
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>α</mi><mrow><mi>i</mi><mo>,</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msub><mi>δ</mi><mi>i</mi></msub><msup><mi>ℒ</mi><mtext mathvariant="normal">HMM</mtext></msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>θ</mi><mrow><mo>*</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup><mo>∣</mo><msub><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>X</mi><mrow><mn>1</mn><mo>,</mo><msup><mi>t</mi><mo>*</mo></msup></mrow><mo>*</mo></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><msup><mi>t</mi><mo>*</mo></msup></msub><mo stretchy="true" form="postfix">)</mo></mrow><msup><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mn>1</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>α</mi><mrow><mi>i</mi><mo>,</mo><mi>t</mi></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msup><mi>ℒ</mi><mtext mathvariant="normal">HMM</mtext></msup><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>θ</mi><mrow><mo>*</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msup><mo>∣</mo><msub><mrow><mo stretchy="true" form="prefix">(</mo><msubsup><mi>X</mi><mrow><mi>t</mi><mo>,</mo><msup><mi>t</mi><mo>*</mo></msup></mrow><mo>*</mo></msubsup><mo stretchy="true" form="postfix">)</mo></mrow><msup><mi>t</mi><mo>*</mo></msup></msub><mo stretchy="true" form="postfix">)</mo></mrow><msup><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>X</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msub><mi>γ</mi><mrow><mi>j</mi><mi>i</mi></mrow></msub><msub><mi>α</mi><mrow><mi>j</mi><mo>,</mo><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>,</mo><mspace width="1.0em"></mspace><mi>t</mi><mo>=</mo><mn>2</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>T</mi><mi>.</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
\alpha_{i,1} &amp;= \delta_i \mathcal{L}^\text{HMM}(\theta^{*(i)}\mid (X^*_{1,t^*})_{t^*})f^{(i)}(X_1), \\
\alpha_{i,t} &amp;= \mathcal{L}^\text{HMM}(\theta^{*(i)}\mid (X^*_{t,t^*})_{t^*}) f^{(i)}(X_t)\sum_{j=1}^{N}\gamma_{ji}\alpha_{j,t-1}, \quad t=2,\dots,T.
\end{align*}</annotation></semantics></math></p>
</div>
<div class="section level2">
<h2 id="challenges-associated-with-the-likelihood-maximization">Challenges associated with the likelihood maximization<a class="anchor" aria-label="anchor" href="#challenges-associated-with-the-likelihood-maximization"></a>
</h2>
<p>To account for parameter constraints associated with the transition
probabilities (and potentially the parameters of the state-dependent
distributions), we use parameter transformations. To ensure that the
entries of the t.p.m.s fulfill non-negativity and the unity condition,
we estimate unconstrained values
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>η</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>i</mi><mo>≠</mo><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">(\eta_{ij})_{i\neq j}</annotation></semantics></math>
for the non-diagonal entries of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Γ</mi><annotation encoding="application/x-tex">\Gamma</annotation></semantics></math>
and derive the probabilities using the multinomial logit link
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>γ</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mfrac><mrow><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>η</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">]</mo></mrow></mrow><mrow><mn>1</mn><mo>+</mo><munder><mo>∑</mo><mrow><mi>k</mi><mo>≠</mo><mi>i</mi></mrow></munder><mo>exp</mo><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>η</mi><mrow><mi>i</mi><mi>k</mi></mrow></msub><mo stretchy="true" form="postfix">]</mo></mrow></mrow></mfrac><mo>,</mo><mspace width="0.222em"></mspace><mi>i</mi><mo>≠</mo><mi>j</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
\gamma_{ij}=\frac{\exp[\eta_{ij}]}{1+\sum_{k\neq i}\exp[\eta_{ik}]},~i\neq j
\end{align*}</annotation></semantics></math> rather than estimating the
probabilities
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>γ</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>i</mi><mo>,</mo><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">(\gamma_{ij})_{i,j}</annotation></semantics></math>
directly. The diagonal entries result from the unity condition as
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>γ</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub><mo>=</mo><mn>1</mn><mo>−</mo><munder><mo>∑</mo><mrow><mi>j</mi><mo>≠</mo><mi>i</mi></mrow></munder><msub><mi>γ</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mi>.</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align*}
\gamma_{ii}=1-\sum_{j\neq i}\gamma_{ij}.
\end{align*}</annotation></semantics></math> Furthermore, variances are
strictly positive, which can be achieved by applying an exponential
transformation to the unconstrained estimator.</p>
<p>When numerically maximizing the likelihood using some
Newton-Raphson-type method, we often face numerical under- or overflow,
which can be addressed by maximizing the logarithm of the likelihood and
incorporating constants in a conducive way, see <span class="citation">Zucchini, MacDonald, and Langrock (<a href="#ref-zuc16">2016</a>)</span> and <span class="citation">Oelschläger and Adam (<a href="#ref-oel21">2021</a>)</span> for details.</p>
<p>As the likelihood is maximized with respect to a relatively large
number of parameters, the obtained maximum can be a local rather than
the global one. To avoid this problem, it is recommended to run the
maximization multiple times from different, possibly randomly selected
starting points, and to choose the model that corresponds to the highest
likelihood, again see <span class="citation">Zucchini, MacDonald, and
Langrock (<a href="#ref-zuc16">2016</a>)</span> and <span class="citation">Oelschläger and Adam (<a href="#ref-oel21">2021</a>)</span> for details.</p>
</div>
<div class="section level2">
<h2 id="application">Application<a class="anchor" aria-label="anchor" href="#application"></a>
</h2>
<p>For illustration, we fit a 3-state HMM with state-dependent
t-distributions to the DAX data that we prepared in the previous
vignette on data management:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">controls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  states <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  sdds   <span class="op">=</span> <span class="st">"t"</span>,</span>
<span>  data   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>file        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"dax.csv"</span>, package <span class="op">=</span> <span class="st">"fHMM"</span><span class="op">)</span>,</span>
<span>                date_column <span class="op">=</span> <span class="st">"Date"</span>,</span>
<span>                data_column <span class="op">=</span> <span class="st">"Close"</span>,</span>
<span>                from        <span class="op">=</span> <span class="st">"2000-01-01"</span>,</span>
<span>                to          <span class="op">=</span> <span class="st">"2021-12-31"</span>,</span>
<span>                logreturns  <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  fit    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"runs"</span> <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">controls</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_controls.html">set_controls</a></span><span class="op">(</span><span class="va">controls</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prepare_data.html">prepare_data</a></span><span class="op">(</span><span class="va">controls</span><span class="op">)</span></span></code></pre></div>
<p>The <code>data</code> object can be directly passed to the
<code><a href="../reference/fit_model.html">fit_model()</a></code> function that numerically maximizes the model’s
(log-) likelihood function <code>runs = 100</code> times.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;For convenience, the &lt;code&gt;controls&lt;/code&gt; object is
saved in &lt;code&gt;data&lt;/code&gt;.&lt;/p&gt;"><sup>2</sup></a> This task can be
parallelized by setting the <code>ncluster</code> argument.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;If you avoid any problems with clustering on your OS,
use &lt;code&gt;ncluster = 1&lt;/code&gt; which avoids any dependency on packages
that provide clustering.&lt;/p&gt;"><sup>3</sup></a></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dax_model_3t</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_model.html">fit_model</a></span><span class="op">(</span><span class="va">data</span>, seed <span class="op">=</span> <span class="fl">1</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>The estimated model is saved in the <a href="https://loelschlaeger.de/fHMM/">fHMM</a> package and
can be accessed as follows:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">dax_model_3t</span><span class="op">)</span></span></code></pre></div>
<p>Calling the <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> method provides an overview of the
model fit:<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Alternatively, &lt;code&gt;&lt;a href="https://rdrr.io/r/stats/coef.html" class="external-link"&gt;coef()&lt;/a&gt;&lt;/code&gt; only returns the
estimated model coefficients&lt;/p&gt;'><sup>4</sup></a></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">dax_model_3t</span><span class="op">)</span></span>
<span><span class="co">#&gt; Summary of fHMM model</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   simulated hierarchy       LL       AIC       BIC</span></span>
<span><span class="co">#&gt; 1     FALSE     FALSE 17650.02 -35270.05 -35169.85</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; State-dependent distributions:</span></span>
<span><span class="co">#&gt; t() </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimates:</span></span>
<span><span class="co">#&gt;                   lb   estimate        ub</span></span>
<span><span class="co">#&gt; Gamma_2.1  2.754e-03  5.024e-03 9.110e-03</span></span>
<span><span class="co">#&gt; Gamma_3.1  2.808e-16  2.781e-16 2.739e-16</span></span>
<span><span class="co">#&gt; Gamma_1.2  1.006e-02  1.839e-02 3.338e-02</span></span>
<span><span class="co">#&gt; Gamma_3.2  1.514e-02  2.446e-02 3.927e-02</span></span>
<span><span class="co">#&gt; Gamma_1.3  5.596e-17  5.549e-17 5.464e-17</span></span>
<span><span class="co">#&gt; Gamma_2.3  1.196e-02  1.898e-02 2.993e-02</span></span>
<span><span class="co">#&gt; mu_1      -3.862e-03 -1.793e-03 2.754e-04</span></span>
<span><span class="co">#&gt; mu_2      -7.994e-04 -2.649e-04 2.696e-04</span></span>
<span><span class="co">#&gt; mu_3       9.642e-04  1.272e-03 1.579e-03</span></span>
<span><span class="co">#&gt; sigma_1    2.354e-02  2.586e-02 2.840e-02</span></span>
<span><span class="co">#&gt; sigma_2    1.225e-02  1.300e-02 1.380e-02</span></span>
<span><span class="co">#&gt; sigma_3    5.390e-03  5.833e-03 6.312e-03</span></span>
<span><span class="co">#&gt; df_1       5.550e+00  1.084e+01 2.116e+01</span></span>
<span><span class="co">#&gt; df_2       6.785e+00  4.866e+01 3.489e+02</span></span>
<span><span class="co">#&gt; df_3       3.973e+00  5.248e+00 6.934e+00</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; States:</span></span>
<span><span class="co">#&gt; decoded</span></span>
<span><span class="co">#&gt;    1    2    3 </span></span>
<span><span class="co">#&gt;  704 2926 2252 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Residuals:</span></span>
<span><span class="co">#&gt;      Min.   1st Qu.    Median      Mean   3rd Qu.      Max. </span></span>
<span><span class="co">#&gt; -3.517900 -0.664018  0.012170 -0.003262  0.673180  3.693568</span></span></code></pre></div>
<p>The estimated state-dependent distributions can be plotted as
follows:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dax_model_3t</span>, plot_type <span class="op">=</span> <span class="st">"sdds"</span><span class="op">)</span></span></code></pre></div>
<p><img src="fHMM-plot-sdds-1.png" width="80%" style="display: block; margin: auto;"></p>
<p>As mentioned above, the HMM likelihood function is prone to local
optima. This effect can be visualized by plotting the log-likelihood
value in the different optimization runs, where the best run is marked
in red:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">dax_model_3t</span>, plot_type <span class="op">=</span> <span class="st">"ll"</span><span class="op">)</span></span></code></pre></div>
<p><img src="fHMM-plot-lls-1.png" width="80%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-oel21" class="csl-entry">
Oelschläger, L., and T. Adam. 2021. <span>“Detecting Bearish and Bullish
Markets in Financial Time Series Using Hierarchical Hidden Markov
Models.”</span> <em>Statistical Modelling</em>. <a href="https://doi.org/10.1177/1471082X211034048" class="external-link">https://doi.org/10.1177/1471082X211034048</a>.
</div>
<div id="ref-zuc16" class="csl-entry">
Zucchini, W., I. L. MacDonald, and R. Langrock. 2016. <span>“Hidden
Markov Models for Time Series: An Introduction Using <span>R</span>, 2nd
Edition.”</span> <em>Chapman and Hall/CRC</em>.
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://loelschlaeger.de" class="external-link">Lennart Oelschläger</a>, <a href="https://www.uni-bielefeld.de/fakultaeten/wirtschaftswissenschaften/lehrbereiche/statisticalmodelling/" class="external-link">Timo Adam</a>, <a href="https://ekvv.uni-bielefeld.de/pers_publ/publ/PersonDetail.jsp?personId=241029889" class="external-link">Rouven Michels</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
