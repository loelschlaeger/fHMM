---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-"
)
library("fHMM")
model <- fHMM::dax_model_3t
data <- model$data
```

# HMMs for Finance <a href="https://loelschlaeger.de/fHMM/"><img src="man/figures/logo.png" align="right" height="139" /></a>

<!-- badges: start -->
[![CRAN status](https://www.r-pkg.org/badges/version/fHMM)](https://CRAN.R-project.org/package=fHMM)
[![metacran downloads](https://cranlogs.r-pkg.org/badges/last-month/fHMM)](https://cran.r-project.org/package=fHMM)
[![R-CMD-check](https://github.com/loelschlaeger/fHMM/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/loelschlaeger/fHMM/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

The `{fHMM}` R package allows for the detection and characterization of financial market regimes in time series data by applying hidden Markov Models (HMMs). The [detailed documentation](https://loelschlaeger.de/fHMM/articles/) outlines the functionality and the model formulation. Below, we provide an initial application to the German stock index [DAX](https://en.wikipedia.org/wiki/DAX).

## Installation

You can install the released version of `{fHMM}` from [CRAN](https://CRAN.R-project.org) with:

```{r, eval = FALSE}
install.packages("fHMM")
```

And the development version from [GitHub](https://github.com/) with:

```{r, eval = FALSE}
# install.packages("devtools")
devtools::install_github("loelschlaeger/fHMM")
```

## Contributing

We are open to contributions and would appreciate your input! If you encounter any issues, please [submit bug reports as issues](https://github.com/loelschlaeger/fHMM/issues/new?assignees=&labels=bug&template=bug.md). If you have any ideas for new features, please submit them as [feature requests](https://github.com/loelschlaeger/fHMM/issues/new?assignees=&labels=future&template=suggestion.md). If you would like to add extensions to the package, please fork the "master" branch and submit merge requests. We look forward to your contributions!

## Example 1: Fitting an HMM to the DAX

We fit a 3-state HMM with state-dependent t-distributions to the DAX log-returns from 2000 to 2022. The states can be interpreted as proxies for bearish (green below) and bullish markets (red) and an "in-between" market state (yellow).

```{r}
library("fHMM")
```

The package has a build-in function to download financial data from [Yahoo Finance](https://finance.yahoo.com/):

```{r data download, eval = FALSE}
dax <- download_data(symbol = "^GDAXI", file = NULL, verbose = FALSE)
```

We first need to define the model:

```{r controls, eval = FALSE}
controls <- set_controls(
  states      = 3,
  sdds        = "t",
  file        = dax,
  date_column = "Date",
  data_column = "Close",
  logreturns  = TRUE,
  from        = "2000-01-01",
  to          = "2022-12-31"
)
```

The function `prepare_data()` then prepares the data for estimation:

```{r data, eval = FALSE}
data <- prepare_data(controls)
```

The `summary()` method gives an overview:

```{r summary_data}
summary(data)
```

We fit the model and subsequently decode the hidden states and compute (pseudo-) residuals:

```{r fit, eval = FALSE}
model <- fit_model(data)
model <- decode_states(model)
model <- compute_residuals(model)
```

The `summary()` method gives an overview of the model fit:

```{r summary_model}
summary(model)
```

Having estimated the model, we can visualize the state-dependent distributions and the decoded time series:

```{r plot_model_fit, fig.dim = c(10,6)}
events <- fHMM_events(
  list(dates = c("2001-09-11", "2008-09-15", "2020-01-27"),
       labels = c("9/11 terrorist attack", "Bankruptcy Lehman Brothers", "First COVID-19 case Germany"))
)
plot(model, plot_type = c("sdds","ts"), events = events)
```

The (pseudo-) residuals help to evaluate the model fit:

```{r plot_model_residuals, fig.dim = c(10,6)}
plot(model, plot_type = "pr")
```

## Example 2: Simulating HMM data and maximizing the likelihood

```{r, eval = FALSE}
### define the model: 3-state HMM with normal sdds
controls <- list(states = 3, sdds = "normal")

### define the true parameters (un-specified parameters are set at random)
Gamma <- matrix(c(0.9, 0.05, 0.05, 0.05, 0.9, 0.05, 0.05, 0.05, 0.9), 3, 3)
mu <- -1:1
sigma <- c(1, 1.5, 2)
true_parameters <- fHMM_parameters(
  controls = controls, Gamma = Gamma, mu = mu, sigma = sigma
)

### simulate 1000 data points
data <- simulate_hmm(controls, horizon = 1000, true_parameters = true_parameters)

### plot the data just for fun
plot(data$data, col = data$markov_chain, type = "h")

### transform the parameters to a vector of the identified and unconstrained 
### parameters
parUncon <- par2parUncon(true_parameters, controls)

### evaluate the (negative) log-likelihood
ll_hmm(parUncon, data$observations, controls)
ll_hmm(parUncon, data$observations, controls, negative = TRUE)

### optimize the likelihood (should only take some seconds)
estimate <- nlm(
    f = ll_hmm, p = parUncon, observations = data$observations, 
    controls = controls, negative = TRUE
  )$estimate

### transform the identified and unconstrained parameters back to the full and 
### interpretable parameters
class(estimate) <- "parUncon"
estimated_parameters <- fHMM:::parUncon2par(estimate, controls)

### we can compare the true parameters with the estimated parameters (should be similar)
true_parameters$Gamma
estimated_parameters$Gamma

true_parameters$mu
estimated_parameters$mu

true_parameters$sigma
estimated_parameters$sigma
```
